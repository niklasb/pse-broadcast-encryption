\documentclass[a4paper,10pt]{scrartcl}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{booktabs}
\usepackage{import}
\usepackage{xspace}
\usepackage{enumitem}
\usepackage{cite}
\usepackage{graphicx}
\usepackage{tikz}
\usepackage{wrapfig}
\usepackage{pdflscape}
\usetikzlibrary{arrows}
\usetikzlibrary{fit}
\usetikzlibrary{calc}
\usepackage{float}
\usepackage{amssymb}
\usepackage{listings}
\usepackage[section]{placeins} % don't move figures beyond the next section heading

% this is needed for forms and links within the text
\usepackage{hyperref}

% Variables
\newcommand{\authorName}{
   Mohammed~Abu~Jayyab,
   Niklas~Baumstark,
   Tobias~Gräf,
   Amrei~Loose,
   Christoph~Michel
}
\newcommand{\authorNameEmph}{
   Mohammed~Abu~Jayyab,
   \textbf{Niklas~Baumstark},
   Tobias~Gräf,
   Amrei~Loose,
   Christoph~Michel
}

\newcommand{\dateFirstVersion}{\today}
\newcommand{\customer}{Karlsruhe Institute of Technology}
\newcommand{\contractor}{A company}
\newcommand{\projectName}{Broadcast Encryption\xspace}

\newcommand{\doctitle}{\projectName (Implementation document)}
\title{\doctitle}
\author{\authorName}
\date{\today}

\include{style}

\begin{document}

\input{frontpage}
\tableofcontents
\clearpage

\section{Introduction}
This document contains the changes applied on the implementation with respect to the design document.
Some of these changes were necessary, and then there are additional changes to improve the performance.
The elements as attributes, methods and classes were renamed, whenever it was useful. In the following the 
changes are listed and described.

\section{Changes in the packages}
\subsection{Package cryptocast.comm}

\begin{itemize}
   \item \textbf{\textit{class DecoratingMessageOutChannel}}
	\begin{itemize}
	 \item This class \textit{"DecoratingMessageOutChannel"} was added for decorating 
	 a message to send with a certain prefix and suffix.
	 \item \textit{"+DecoratingMessageOutChannel(inner: MessageOutChannel, prefix: byte[] , suffix: byte[])"} was added. 
	\end{itemize}
	 
	\item \textbf{\textit{class SimpleHttpStreamServer}}
	\begin{itemize}
	 \item This class \textit{"SimpleHttpStreamServer"} was added for representing a simple tcp based http server.
	 \item \textit{"+SimpleHttpStreamServer(in: InputStream, addr: SocketAddress , contentType:  String , bufsize:  int)"} 
	 was added.
	 \item \textit{"+waitForListener() : int"} was added.
	\end{itemize}
	
   \item \textbf{\textit{class MessageBuffer}}
	\begin{itemize}
	 \item This class \textit{"MessageBuffer"} was added for representing a buffer for all message.
	 \item \textit{"+setBlocking(block: boolean) : void"} was added. 
	 \item \textit{"+close() : void"} was added. 
	\end{itemize}
	
	 \item \textbf{\textit{class StreamUtils}}
	\begin{itemize}
	 \item This class \textit{"StreamUtils"} was added for limiting the number of written bytes per second.
	 \item \textit{"+readall(in: InputStream, buffer: byte[] , offset: int , len: int ) : int"} was added.
	 \item \textit{"+copyInterruptable(in: InputStream , out: OutputStream , bufsize: int) : void"} was added.
	\end{itemize}
	
	 \item \textbf{\textit{class ThrottledOutputStream}}
	\begin{itemize}
	 \item This class \textit{"ThrottledOutputStream"} was added for limiting the number of written bytes per second.
	 \item \textit{"+ThrottledOutputStream(out: OutputStream , maxBytesPerSec: long)"} was added. 
	\end{itemize}
	
   \item \textbf{\textit{class MultiOutputStream}}
  \begin{itemize}
	 \item The class \textit{"MultiOutChannel"} was replaced by this class \textit{"MultiOutputStream"}.
	 \item \textit{"+addChannel(channel : OutChannel) : void"} was replaced by 
	 \textit{"+addChannel(channel : OutputStream ) : void"}.
	 \item \textit{"+removeChannel(channel : OutChannel) : void"} was replaced by 
	 \textit{"+removeChannel(channel : OutputStream ) : void"}.
	 \item \textit{"+send(data : byte[]) : void"} was deleted.
	 \item The static interface \textit{"ErrorHandler"} was added.
	 \item \textit{"+getChannels() : ImmutableList<OutputStream>"} was added.
	 \item \textit{"+MultiOutputStream()"} was added.
	 \item \textit{"+MultiOutputStream(errHandler: ErrorHandler)"} was added.
	 \item \textit{"+handle(multi: MultiOutputStream, channel: OutputStream, exc: IOException) : void"} was added.
	 \item \textit{"+removeOnError : ErrorHandler"} was added.
	 \item \textit{"`+propagateError : ErrorHandler"} was added.
	\end{itemize}
	
   \item \textit{\textbf{class ServerMultiMessageOutChannel}}
	\begin{itemize}
	 \item The class \textit{"SocketMulticastServer"} was replaced by this class \textit{"ServerMultiMessageOutChannel"}.
	 \item \textit{"+SocketMulticastServer(socket : ServerSocket)"} was replaced by 
	 \textit{"+ServerMultiMessageOutChannel(server : ServerSocket , excHandler : Callback<Throwable>)"}.
	 \item \textit{"+send(data : byte[]) : void"} was deleted.
	\end{itemize}
	 
   \item \textbf{\textit{class StatisticalInputStream}}
	\begin{itemize}
	\item The class \textit{"StatisticalInChannel"} was replaced by this class \textit{"StatisticalInputStream"}.
	\item \textit{"+StatisticalInChannel(inner : InChannel)"} was replaced by 
	\textit{"+StatisticalInputStream(inner : InputStream)"}.
	\item \textit{"+recv(size : int, buffer : byte[]) : void"} was deleted.
	\end{itemize}
	
   \item \textbf{\textit{class StatisticalOutputStream}}
	\begin{itemize}
	 \item The class \textit{"StatisticalOutChannel"} was replaced by this class \textit{"StatisticalOutputStream"}.
	 \item \textit{"+StatisticalOutChannel(inner : OutChannel)"} was replaced by 
	 \textit{"+StatisticalOutputStream(inner : OutputStream)"}.
   \item \textit{"+send(data : byte[]) : void"} was deleted.
	\end{itemize}
 
   \item \textbf{\textit{class StreamMessageInChannel}}
	\begin{itemize}
	 \item The class \textit{"MessageInChannel"} was replaced by this \textit{"StreamMessageInChannel"}.
	\end{itemize}
	
   \item \textbf{\textit{class StreamMessageOutChannel}}
	\begin{itemize}
	 \item The class \textit{"MessageOutChannel""} was replaced by this class \textit{"StreamMessageOutChannel"}.
	 \item \textit{"+MessageOutChannel(inner : OutChannel)"} was replaced by 
	 \textit{"+StreamMessageOutChannel(inner : OutputStream)"}.
	 \item \textit{"+sendMessage(data : byte[]) : void"} was replaced by 
	 \textit{"+sendMessage(data: byte[], offset: int , len: int) : void"}.
	\end{itemize}
	
   \item \textbf{\textit{interface MessageInChannel}}
	\begin{itemize}
	 \item The interface \textit{""InChannel"} was renamed to \textit{"MessageInChannel"}.
	 \item \textit{"+recv(size : int, buffer : byte[]) : void"} was replaced by \textit{"+recvMessage() : byte[]"}.
	\end{itemize}
	
	 \item \textbf{\textit{abstract class MessageOutChannel}}
	\begin{itemize}
	 \item The interface \textit{"OutChannel"} was replaced by this abstract class \textit{"MessageOutChannel"}.
	 \item \textit{"+send(data : byte[]) : void"} was renamed to \textit{+sendMessage(data : byte[]) : void"}.
	 \item \textit{"+sendMessage(data: byte[] , offset: int , len: int) : void"} was added.
	\end{itemize}
	
\end{itemize}

\subsection{Package cryptocast.server}

\begin{itemize}
  
\item \textbf{\textit{class Controller}} \newline
The class \textit{Controller} now implements the interface \textit{Observer} so registered observers can 
tell the controllerwhen it has to save the data this controller is connected to.
The following methods were added :
	\begin{itemize}
	 \item \textit{"+start(databaseFile : File , listenAddr : SocketAddress , keyBroadcastIntervalSecs: int ,
		 serverFactory : NPServerFactory) : Controller"} for creating a instance of this class. This method now 
	 	implements the parts of functionality of the former method \textit{"+init()"}  and 
		the constructor. Therefore, the access modifier of the constructor has changed to private and the method  
		\textit{"+init()"} has been removed.
	 \item \textit{"+saveUserKeys(dir : File , users : Set<User<NPIdentity>>) : void"} for saving
		 the personal keys of the users into a key-file at the given directory.
	 \item \textit{"+saveDatabase() : void"} for saving the database into a specific file.
	 \item \textit{"+getModel() : NaorPinkasServerData"} to return the data according to Naor-Pinkas.
	 \item \textit{"+getDatabesFile() : File"} to get the file containing the database or where it should be saved in.
	\item \textit{"+getT() : int"} returns the amount of users who can be revoked in the current cryptography.
	\item \textit{"+getListenAddress() :SocketAddredd"} in order to get the address on which port the server listens.
	 \item \textit{"+reinitializeCrypto(t : int) : void"} to reinitialize the cryptography so that t users can be revoked.
	 \item \textit{"+streamAudio(File file) : void"} to stream a MPEG-3 audio file.
	 \item \textit{"+streamSampleText() : void"} to stream a sample text.
	 \item \textit{"+stream(in : InputStream) : void"} to stream the data from the input stream.
	 \item \textit{"+stream(in : InputStream , maxBytesPerSec : long ) : void"} to stream the data while limiting 
	 	the number of bytes which are read per second.
	\item \textit{"+update(o : Observable, arg : Object) : void)} to save the database when it has changed.
	\end{itemize}
The following methods were removed:
	\begin{itemize}
	\item \textit{"+init()"}. Reasons for this decicision are stated above in the added method \textit{"+start(...)"}.
	\item \textit{"+keyGen(amtRevocable : int, amtPrivateKeys : int, keyDir : File)"}
	\item \textit{"+addUser(name : String)"}, \textit{"+revokeUser(name : String)"}, \textit{"+authorizeUser(name : String)"}
		and \textit{"+showUsers()"} have been moved to the class \textit{ServerData}. Also some of them have been renamed.
	\item \textit{"+showStatistics()"} and \textit{"+showInfo()"} have been removed at all because they were not needed anymore.
	\end{itemize}
\item \textbf{\textit{class Shell<ID>}}\newline
The following method was added:
	\begin{itemize}
	\item \textit{"+Shell(in : BufferedReader, out: PrintStream, err : PrintStream, control: Controller)"}. The parameter \textit{control : Controller}
		has been added.
	\item \textit{"+parseInt(strr : String) : Optional<Integer>"} so that converting Strings to Integer is possible.
	\end{itemize}
	
	\item \textbf{\textit{class ServerData<ID>}}\newline
	The following methods were added :
  \begin{itemize}
 	 \item \textit{"+initAfterDeserialization()"} to initalize the data after it was read from a file.
	 \item \textit{"+update(o : Observable, arg : Object) : void"} TODO
	 \item \textit{"+revoke(users : Set<User<ID>>) : void"} so that we can revoke multiple users at the same time.
	 \item \textit{"+revoke(user : User<ID>) : void"} so that we can revoke only one user.
	 \item \textit{"+unrevoke(user : User<ID>) : void} so that we can authorize a user.
	 \item \textit{"+isRevoked(user : User<ID> ) : boolean"} to let us know if a user is revoked or not.
	 \item \textit{"+Serverdata(userManager : BroadcastSchemeUserManager<ID>, keyManager :  BroadcastSchemeKeyManager<ID>)"} 
		to provide all classes the Serverdata uses.
	 \item \textit{"+getUsers() : Set<User<ID>> "} to return all users in our collection.
	\end{itemize}

   \item \textbf{\textit{class LogbackUtils}}
	\begin{itemize}
	 \item This class was added to provied a logger. The logger is used to provide debug information and to provide information to the user.
	\end{itemize}
	
	 \item \textbf{\textit{class NaorPinkasServerData}}
	\begin{itemize}
	 \item This class \textit{"NaorPinkasServerData"} was added for representing the server data according to Naor-Pinkas.
	\end{itemize}
	
	 \item \textbf{\textit{class OptParse}}
	\begin{itemize}
	 \item This class \textit{"OptParse"} was added for providing a Command line option parser.
	\end{itemize}
	
   \item \textit{\textbf{class ShellCommand}}
	\begin{itemize}
	 \item The class \textit{"ShellCommand"} was added for representing the commands available in the shell.
	\end{itemize}
	
\end{itemize}


\subsection{Package cryptocast.server.programs}
This  completely new package contains some classes used for testing and setting up the server:
\begin{itemize}
	\item \textit{Benchmarks} gathesr data about the time several functions needed by the cryptography are running
		with several paramters. The available benchmarks are  lagrange, encrypt, multi-encrypt, decrypt, multi-eval, keygen, multi-exp.
		TODO: translate bechmarks in proper language, add description below
	\item \textit{Client} starts a cterminal-based client. A keyfile must be provided to it to run.
	\item \textit{HttpStreamer} 
	\item \textit{TcpStreamer}
	\item \textit{Server}: Runs a server.
\end{itemize}
\subsection{Package cryptocast.client}
\subsection{Package cryptocast.client.filechooser}
\subsection{Package cryptocast.client.bufferedmediaplayer}
\subsection{Package cryptocast.crypto}
\subsection{Package cryptocast.crypto.naorpinkas}
\subsection{Package cryptocast.util}



\end{document}

